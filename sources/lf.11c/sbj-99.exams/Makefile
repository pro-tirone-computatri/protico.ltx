# This file is part of the Open Source project 'proTironeComputatri'
# (c) 2025 Karsten Reincke (https://github.com/pro-tirone-computatri/protico.ltx)
# It is distributed under the terms of the creative commons license
# CC-BY-4.0 (= https://creativecommons.org/licenses/by/4.0/)

AUX_EXTS=tmp
RES_EXTS=pdf
DEL_FILE=exercises

# the file into which the sub content is collected
INCOLL=tmp.tmp

LNX_TD="../.."
PTC_TD="../${LNX_TD}"
BLD=${PTC_TD}/built

EVD="../../3ps/eisvogel"

help:
	echo "make [ help | lessons | lesson-exc | exercises | lesson-ort | oraltrack | lesson-zpr | zenprese ] "

# recreates all sbj documents and releases them into the lesson directory tree
lessons: oraltrack zenprese exercises
	@ WD=`pwd` && SJN=`basename $${WD}` && LFN=`cat ../td.lf` && \
	  TGD="${BLD}/$${LFN}" && mkdir -p $${TGD} && \
	  ls *.pdf | while read PDF; do mv $${PDF} $${TGD}/$${SJN}-$${PDF}; done
	@ tree ${BLD}

# --- SECTION EXERCISE ---
# recreates exercise document, releases it into the lesson directory tree
lesson-exc: exercises 
	@ if [ -f exercises.pdf ]; then \
	    WD=`pwd` && SJN=`basename $${WD}` && LFN=`cat ../td.lf` && \
	    TGD="${BLD}/$${LFN}" && mkdir -p $${TGD} && \
    	    mv exercises.pdf $${TGD}/$${SJN}-exercises.pdf; \
	  fi
	@ tree ${BLD}

exc: exercises

exercises: 
	@ echo "collecting exercises"
	@ if [ -f "${INCOLL}" ]; then rm "${INCOLL}"; fi
	@ find . -type d -name "tpc*" | sort | while read d; do\
		find $${d} -type f -name "oraltrack.md" | sort | while read f; do\
			cat $${f} >> "${INCOLL}";\
			echo "collecting exercise base of $$f";\
	  done;\
	done;
	@ if [ -f "${INCOLL}" ]; then \
		bash ${LNX_TD}/bin/extract-exercises.sh ${INCOLL}; \
	  if [ -f exercises.md ]; then make exercises.pdf; fi; \
	fi
	@ make clear

# --- SECTION ORALTRACK ---
# recreates oraltrack document, releases it into the lesson directory tree
lesson-ort: oraltrack
	@ WD=`pwd` && SJN=`basename $${WD}` && LFN=`cat ../td.lf` && \
	  TGD="${BLD}/$${LFN}" && mkdir -p $${TGD} && \
    mv oraltrack.pdf $${TGD}/$${SJN}-oraltrack.pdf	
	@ tree ${BLD}

ort: oraltrack

oraltrack:
	@ echo "collecting oraltracks"
	@ if [ -f "${INCOLL}" ]; then rm "${INCOLL}"; fi
	@ find . -type d -name "tpc*" | sort | while read d; do\
		find $${d} -type f -name "oraltrack.md" | sort | while read f; do\
			cat $${f} >> ${INCOLL};\
			echo "adopting content of $$f";\
	  done;\
	done;
	@ pandoc header.md ${INCOLL} -o oraltrack.pdf --from markdown --template ${EVD}/eisvogel.latex --listings -V lang=de-DE
	@ make clear

# --- SECTION ZENPRESE ---
# recreates the zp document, releases it into the lesson directory tree
lesson-zpr: zenprese
	@ WD=`pwd` && SJN=`basename $${WD}` && LFN=`cat ../td.lf` && \
	  TGD="${BLD}/$${LFN}" && mkdir -p $${TGD} && \
    mv zenprese.pdf $${TGD}/$${SJN}-zenprese.pdf	
	@ tree ${BLD}

zpr: zenprese

zenprese:
	@ echo "writing zenprese"
	@ (cd zp && make clean && make zp.pdf && mv zp.pdf ../zenprese.pdf)

.SUFFIXES: .md .pdf 

.md.pdf:
	@ echo "### `date +'%Y%m%dT%H%M%S'`"
	@ echo "### converting $< to $@"
	@ pandoc header.md $< -o $@ --from markdown --template ${EVD}/eisvogel.latex --listings -V lang=de-DE
	@ make clear

clear:
	$(foreach EXT, ${AUX_EXTS}, if [ ! "x`ls *.${EXT} 2>/dev/null`" = "x" ]; then rm *.${EXT}; fi;)
	(cd zp && make clear)

clean:	clear
	$(foreach EXT, ${RES_EXTS}, @if [ ! "x`ls *.${EXT} 2>/dev/null`" = "x" ]; then rm *.${EXT}; echo "removing existing .${EXT}-target-files"; fi;)
	$(foreach BNA, ${DEL_FILE}, @if [ ! "x`ls ${BNA}.* 2>/dev/null`" = "x" ]; then rm ${BNA}.*; echo "removing existing derivated ${BNA}.*"; fi;)
	(cd zp && make clean)
	find . -type d -name "tpc*" | while read d; do (cd $$d && make clean); done

